---
title: "Player Data Prep"
author: "Xavier Genelin"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(nflverse)
library(fst)
```


```{r seasons}
start_season <- 2015
```

# Weekly Data

```{r player_weekly}
player_weekly <- load_player_stats(seasons = c(start_season:most_recent_season()), stat_type = "offense") %>%
  filter(season_type == "REG") %>%
  filter(position_group %in% c("QB", "RB", "TE", "WR")) %>%
  mutate(position = ifelse(str_trim(position) == "HB", "RB", position)) %>%
  rename(Player = player_display_name,
         Completions = completions,
         Attempts = attempts,
         `Passing Yds` = passing_yards,
         `Passing TDs` = passing_tds,
         Interceptions = interceptions,
         Sacks = sacks,
         `Sack Yards` = sack_yards,
         `Sack Fum` = sack_fumbles,
         `Sack Fum Lost` = sack_fumbles_lost,
         `Passing Air Yds` = passing_air_yards,
         `Passing YAC` = passing_yards_after_catch,
         `Passing 1st Downs` = passing_first_downs,
         `Passing EPA` = passing_epa,
         `Passing 2pt Conv` = passing_2pt_conversions,
         Carries = carries,
         `Rushing Yds` = rushing_yards,
         `Rushing TDs` = rushing_tds,
         `Rushing Fum` = rushing_fumbles,
         `Rushing Fum Lost` = rushing_fumbles_lost,
         `Rushing 1st Downs` = rushing_first_downs,
         `Rushing EPA` = rushing_epa,
         `Rushing 2pt Conv` = rushing_2pt_conversions,
         Receptions = receptions,
         Targets = targets,
         `Receiving Yds` = receiving_yards,
         `Receiving TDs` = receiving_tds,
         `Receiving Fum` = receiving_fumbles,
         `Receiving Fum Lost` = receiving_fumbles_lost,
         `Receiving Air Yds` = receiving_air_yards,
         `Receiving YAC` = receiving_yards_after_catch,
         `Receiving 1st Downs` = receiving_first_downs,
         `Receiving 2pt Conv` = receiving_2pt_conversions,
         `Target Share` = target_share,
         `Air Yds Share` = air_yards_share,
         `Special Teams TDs` = special_teams_tds,
         `Fantasy Points` = fantasy_points,
         `Fantasy Points PPR` = fantasy_points_ppr)

player_weekly
```

# Season

```{r player_season}
player_season <- player_weekly %>%
  group_by(player_id, Player, season, position, headshot_url) %>%
  summarise(Completions = sum(Completions),
            Attempts = sum(Attempts),
            `Passing Yds` = sum(`Passing Yds`),
            `Passing TDs` = sum(`Passing TDs`),
            Interceptions = sum(Interceptions),
            Sacks = sum(Sacks),
            `Sack Yds` = sum(`Sack Yards`),
            `Sack Fum` = sum(`Sack Fum`),
            `Sack Fum Lost` = sum(`Sack Fum Lost`),
            `Passing YAC` = sum(`Passing YAC`),
            `Passing 1st Downs` = sum(`Passing 1st Downs`),
            `Passing 2pt Conv` = sum(`Passing 2pt Conv`),
            Carries = sum(Carries),
            `Rushing Yds` = sum(`Rushing Yds`),
            `Rushing TDs` = sum(`Rushing TDs`),
            `Rushing Fum` = sum(`Rushing Fum`),
            `Rushing Fum Lost` = sum(`Rushing Fum Lost`),
            `Rushing 1st Downs` = sum(`Rushing 1st Downs`),
            `Rushing 2pt Conv` = sum(`Rushing 2pt Conv`),
            Receptions = sum(Receptions),
            Targets = sum(Targets),
            `Receiving Yards` = sum(`Receiving Yds`),
            `Receiving TDs` = sum(`Receiving TDs`),
            `Receiving Fum` = sum(`Receiving Fum`),
            `Receiving Fum Lost` = sum(`Receiving Fum Lost`),
            `Receiving Air Yards` = sum(`Receiving Air Yds`),
            `Receiving YAC` = sum(`Receiving YAC`),
            `Receiving 1st Downs` = sum(`Receiving 1st Downs`),
            `Receiving 2pt Conv` = sum(`Receiving 2pt Conv`),
            `Special Teams TDs` = sum(`Special Teams TDs`),
            `Fantasy Points` = sum(`Fantasy Points`),
            `Fantasy Points PPR` = sum(`Fantasy Points PPR`))

player_season
```

# Save to fst files

```{r player_fsts}
write.fst(player_season, "data/player_season.fst")
write.fst(player_weekly, "data/player_weekly.fst")
```